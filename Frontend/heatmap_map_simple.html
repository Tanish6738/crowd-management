<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Public Facilities Map with Heatmap</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <!-- Leaflet Routing Machine CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            margin: 0;
            font-size: 2rem;
            font-weight: 300;
        }

        .header p {
            margin: 0.5rem 0 0 0;
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .controls {
            background: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.6rem 1.2rem;
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }

        .btn.active {
            background: #28a745;
        }

        .btn.heatmap-active {
            background: #ff6b6b;
        }

        .info-panel {
            background: white;
            padding: 1rem;
            margin: 1rem 2rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: none;
        }

        .info-panel.show {
            display: block;
        }

        #map {
            height: calc(100vh - 200px);
            margin: 1rem 2rem;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .marker-info {
            font-family: 'Segoe UI', sans-serif;
            max-width: 300px;
        }

        .marker-info h3 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 1.2rem;
        }

        .marker-info p {
            margin: 5px 0;
            color: #666;
            font-size: 0.9rem;
        }

        .marker-info .description {
            background: #f8f9fa;
            padding: 8px;
            border-radius: 5px;
            margin-top: 8px;
            font-style: italic;
        }

        .directions-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85rem;
            margin-top: 10px;
            margin-right: 5px;
            transition: background 0.3s;
        }

        .directions-btn:hover {
            background: #218838;
        }

        .clear-route-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85rem;
            margin-top: 10px;
            transition: background 0.3s;
        }

        .clear-route-btn:hover {
            background: #c82333;
        }

        .route-info {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-size: 0.9rem;
        }

        .route-info h4 {
            margin: 0 0 5px 0;
            color: #1976d2;
        }

        .heatmap-info {
            background: #ffebee;
            border-left: 4px solid #f44336;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-size: 0.9rem;
        }

        .heatmap-info h4 {
            margin: 0 0 5px 0;
            color: #d32f2f;
        }

        .status-bar {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 0.9rem;
            z-index: 1000;
            display: none;
        }

        /* Mobile responsive */
        @media (max-width: 768px) {
            .header {
                padding: 1rem;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }
            
            .controls {
                padding: 1rem;
                flex-direction: column;
                align-items: stretch;
            }
            
            .control-group {
                justify-content: center;
            }
            
            #map {
                margin: 1rem;
                height: calc(100vh - 250px);
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üó∫Ô∏è Public Facilities Map with Heatmap</h1>
        <p>Find facilities and view user activity heatmap</p>
    </div>

    <div class="controls">
        <div class="control-group">
            <button class="btn" id="locateBtn">
                üìç Find My Location
            </button>
            <button class="btn" id="refreshBtn">
                üîÑ Refresh Data
            </button>
            <button class="btn" id="clearRouteBtn" style="display: none;">
                ‚ùå Clear Route
            </button>
        </div>
        <div class="control-group">
            <button class="btn" id="toggleHeatmapBtn">
                üî• Show Heatmap
            </button>
            <button class="btn" id="trackLocationBtn">
                üìä Share My Location
            </button>
        </div>
        <div class="control-group">
            <span id="markerCount">Loading...</span>
        </div>
    </div>

    <div class="info-panel" id="locationInfo">
        <h3>üìç Your Location</h3>
        <p id="locationText">Location services not available</p>
    </div>

    <div class="info-panel" id="routeInfo">
        <h3>üß≠ Route Information</h3>
        <div id="routeDetails">No active route</div>
    </div>

    <div class="info-panel" id="heatmapInfo">
        <h3>üî• Heatmap Information</h3>
        <div id="heatmapDetails">Heatmap not active</div>
    </div>

    <div id="map"></div>

    <div class="status-bar" id="statusBar">Ready</div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <!-- Leaflet Routing Machine JS -->
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    <!-- Leaflet Heatmap JS -->
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    
    <script>
        // Global variables
        let map;
        let userLocationMarker = null;
        let markers = [];
        let mapData = {};
        let routingControl = null;
        let userLocation = null;
        let heatmapLayer = null;
        let isHeatmapVisible = false;
        let isTrackingLocation = false;
        let trackingInterval = null;

        // Marker icons mapping
        const markerIcons = {
            hospital: 'üè•',
            public_washroom: 'üöª',
            school: 'üè´',
            police_station: 'üöî',
            fire_station: 'üöí',
            atm: 'üèß',
            bank: 'üè¶',
            pharmacy: 'üíä',
            gas_station: '‚õΩ',
            restaurant: 'üçΩÔ∏è',
            hotel: 'üè®',
            shopping_mall: 'üõçÔ∏è',
            bus_stop: 'üöå',
            metro_station: 'üöá',
            parking: 'üÖøÔ∏è',
            post_office: 'üìÆ',
            library: 'üìö',
            mosque: 'üïå',
            temple: 'üõï',
            church: '‚õ™',
            park: 'üå≥',
            gym: 'üí™',
            cinema: 'üé¨',
            market: 'üõí',
            government_office: 'üèõÔ∏è'
        };
        const API_BASE = 'http://localhost:8000';
        // Initialize map
        function initMap() {
            // Create map centered on Delhi
            map = L.map('map').setView([28.6139, 77.2090], 12);

            // Add tile layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);

            // Load map data
            loadMapData();
        }

        // Load map data from API
        async function loadMapData() {
            try {
                showStatus('Loading map data...');
                const response = await fetch(`${API_BASE}/api/user-map-data`);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                mapData = await response.json();
                displayMarkers();
                updateMarkerCount();
                showStatus('Map data loaded successfully', 2000);
                
            } catch (error) {
                console.error('Error loading map data:', error);
                showStatus('Error loading map data', 3000);
            }
        }

        // Display markers on map
        function displayMarkers() {
            // Clear existing markers
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];

            // Add new markers
            mapData.markers.forEach(markerData => {
                const icon = createMarkerIcon(markerData.type);
                
                const marker = L.marker([markerData.lat, markerData.lng], { icon })
                    .addTo(map);

                // Create popup content
                const popupContent = createPopupContent(markerData);
                marker.bindPopup(popupContent, { maxWidth: 300 });

                markers.push(marker);
            });
        }

        // Create custom marker icon
        function createMarkerIcon(type) {
            const emoji = markerIcons[type] || 'üìç';
            return L.divIcon({
                className: 'custom-marker',
                html: `<div style="font-size: 24px; text-shadow: 2px 2px 4px rgba(0,0,0,0.7); filter: drop-shadow(0 0 3px white);">${emoji}</div>`,
                iconSize: [30, 30],
                iconAnchor: [15, 15],
                popupAnchor: [0, -15]
            });
        }

        // Create popup content for markers
        function createPopupContent(markerData) {
            const typeName = markerData.type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            
            return `
                <div class="marker-info">
                    <h3>${markerIcons[markerData.type] || 'üìç'} ${markerData.name}</h3>
                    <p><strong>Type:</strong> ${typeName}</p>
                    <p><strong>Location:</strong> ${markerData.lat.toFixed(6)}, ${markerData.lng.toFixed(6)}</p>
                    ${markerData.description ? `<div class="description">${markerData.description}</div>` : ''}
                    <button class="directions-btn" onclick="getDirections(${markerData.lat}, ${markerData.lng}, '${markerData.name}')">
                        üß≠ Get Directions
                    </button>
                    ${routingControl ? `<button class="clear-route-btn" onclick="clearRoute()">‚ùå Clear Route</button>` : ''}
                </div>
            `;
        }

        // Get user's current location
        function getUserLocation() {
            if (!navigator.geolocation) {
                showStatus('Geolocation is not supported by this browser', 3000);
                return;
            }

            showStatus('Getting your location...');
            
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    showUserLocation(lat, lng);
                    showStatus('Location found!', 2000);
                },
                function(error) {
                    let errorMessage = 'Unable to get your location';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = 'Location access denied by user';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = 'Location information unavailable';
                            break;
                        case error.TIMEOUT:
                            errorMessage = 'Location request timed out';
                            break;
                    }
                    showStatus(errorMessage, 4000);
                    console.error('Geolocation error:', error);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 300000
                }
            );
        }

        // Show user location on map
        function showUserLocation(lat, lng) {
            // Store user location for routing
            userLocation = { lat: lat, lng: lng };
            
            // Remove existing user location marker
            if (userLocationMarker) {
                map.removeLayer(userLocationMarker);
            }

            // Add new user location marker
            userLocationMarker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'user-location-marker',
                    html: '<div style="background: #007bff; border: 3px solid white; border-radius: 50%; width: 20px; height: 20px; box-shadow: 0 0 10px rgba(0,123,255,0.5);"></div>',
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                })
            }).addTo(map);

            userLocationMarker.bindPopup(`
                <div class="marker-info">
                    <h3>üìç Your Location</h3>
                    <p><strong>Coordinates:</strong> ${lat.toFixed(6)}, ${lng.toFixed(6)}</p>
                </div>
            `);

            // Center map on user location
            map.setView([lat, lng], 15);

            // Update location info panel
            document.getElementById('locationText').textContent = 
                `Lat: ${lat.toFixed(6)}, Lng: ${lng.toFixed(6)}`;
            document.getElementById('locationInfo').classList.add('show');
        }

        // Get directions to a location using the integrated map
        function getDirections(lat, lng, name) {
            if (!userLocation) {
                // Try to get user location first
                if (navigator.geolocation) {
                    showStatus('Getting your location for directions...');
                    navigator.geolocation.getCurrentPosition(
                        function(position) {
                            userLocation = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude
                            };
                            showUserLocation(userLocation.lat, userLocation.lng);
                            createRoute(userLocation.lat, userLocation.lng, lat, lng, name);
                        },
                        function(error) {
                            showStatus('Please find your location first to get directions', 3000);
                        }
                    );
                } else {
                    showStatus('Geolocation not supported. Please find your location first.', 3000);
                }
                return;
            }

            createRoute(userLocation.lat, userLocation.lng, lat, lng, name);
        }

        // Create route on the map
        function createRoute(fromLat, fromLng, toLat, toLng, destinationName) {
            // Remove existing route
            if (routingControl) {
                map.removeControl(routingControl);
            }

            showStatus(`Creating route to ${destinationName}...`);

            // Create routing control
            routingControl = L.Routing.control({
                waypoints: [
                    L.latLng(fromLat, fromLng),
                    L.latLng(toLat, toLng)
                ],
                routeWhileDragging: false,
                addWaypoints: false,
                createMarker: function() { return null; }, // Don't create additional markers
                lineOptions: {
                    styles: [{
                        color: '#007bff',
                        weight: 5,
                        opacity: 0.8
                    }]
                }
            }).on('routesfound', function(e) {
                const route = e.routes[0];
                const distance = (route.summary.totalDistance / 1000).toFixed(2); // Convert to km
                const time = Math.round(route.summary.totalTime / 60); // Convert to minutes
                
                // Update route info panel
                document.getElementById('routeDetails').innerHTML = `
                    <div class="route-info">
                        <h4>üéØ Route to: ${destinationName}</h4>
                        <p><strong>Distance:</strong> ${distance} km</p>
                        <p><strong>Estimated Time:</strong> ${time} minutes</p>
                        <p><strong>Mode:</strong> Driving</p>
                    </div>
                `;
                
                document.getElementById('routeInfo').classList.add('show');
                document.getElementById('clearRouteBtn').style.display = 'inline-block';
                
                showStatus(`Route created! ${distance}km, ${time} minutes`, 3000);
                
                // Fit map to show the entire route
                const bounds = L.latLngBounds([
                    [fromLat, fromLng],
                    [toLat, toLng]
                ]);
                map.fitBounds(bounds, { padding: [20, 20] });
                
            }).addTo(map);
        }

        // Clear the current route
        function clearRoute() {
            if (routingControl) {
                map.removeControl(routingControl);
                routingControl = null;
                
                document.getElementById('routeInfo').classList.remove('show');
                document.getElementById('clearRouteBtn').style.display = 'none';
                
                showStatus('Route cleared', 2000);
                
                // Update all popup contents to remove clear route button
                markers.forEach((marker, index) => {
                    const markerData = mapData.markers[index];
                    if (markerData) {
                        marker.setPopupContent(createPopupContent(markerData));
                    }
                });
            }
        }

        // Load and display heatmap
        async function loadHeatmap() {
            try {
                showStatus('Loading heatmap data...');
                const response = await fetch(`${API_BASE}/api/heatmap-data?hours=24`);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const heatmapData = await response.json();
                displayHeatmap(heatmapData);
                
            } catch (error) {
                console.error('Error loading heatmap:', error);
                showStatus('Error loading heatmap data', 3000);
            }
        }

        // Display heatmap on map
        function displayHeatmap(data) {
            // Remove existing heatmap
            if (heatmapLayer) {
                map.removeLayer(heatmapLayer);
            }

            // Convert data to format expected by leaflet.heat
            const heatPoints = data.heatmap_points.map(point => [
                point.lat,
                point.lng,
                point.intensity || 1
            ]);

            if (heatPoints.length === 0) {
                showStatus('No location data available for heatmap', 3000);
                return;
            }

            // Create heatmap layer with simple, visible colors
            heatmapLayer = L.heatLayer(heatPoints, {
                radius: 25,
                blur: 15,
                maxZoom: 17,
                gradient: {
                    0.4: 'blue',
                    0.6: 'cyan',
                    0.7: 'lime',
                    0.8: 'yellow',
                    1.0: 'red'
                }
            }).addTo(map);

            // Update heatmap info panel
            document.getElementById('heatmapDetails').innerHTML = `
                <div class="heatmap-info">
                    <h4>üî• User Activity Heatmap</h4>
                    <p><strong>Data Points:</strong> ${data.total_points}</p>
                    <p><strong>Time Range:</strong> Last ${data.time_range_hours || 24} hours</p>
                    <p><strong>Last Updated:</strong> ${new Date(data.last_updated).toLocaleTimeString()}</p>
                    <p><em>Blue (low activity) ‚Üí Red (high activity)</em></p>
                </div>
            `;
            
            document.getElementById('heatmapInfo').classList.add('show');
            showStatus(`Heatmap loaded with ${data.total_points} data points`, 3000);
        }

        // Toggle heatmap visibility
        function toggleHeatmap() {
            const btn = document.getElementById('toggleHeatmapBtn');
            
            if (isHeatmapVisible) {
                // Hide heatmap
                if (heatmapLayer) {
                    map.removeLayer(heatmapLayer);
                }
                document.getElementById('heatmapInfo').classList.remove('show');
                btn.textContent = 'üî• Show Heatmap';
                btn.classList.remove('heatmap-active');
                isHeatmapVisible = false;
                showStatus('Heatmap hidden', 2000);
            } else {
                // Show heatmap
                loadHeatmap();
                btn.textContent = '‚ùÑÔ∏è Hide Heatmap';
                btn.classList.add('heatmap-active');
                isHeatmapVisible = true;
            }
        }

        // Start/stop location tracking
        function toggleLocationTracking() {
            const btn = document.getElementById('trackLocationBtn');
            
            if (isTrackingLocation) {
                // Stop tracking
                if (trackingInterval) {
                    clearInterval(trackingInterval);
                    trackingInterval = null;
                }
                btn.textContent = 'üìä Share My Location';
                btn.classList.remove('active');
                isTrackingLocation = false;
                showStatus('Location tracking stopped', 2000);
            } else {
                // Start tracking
                if (!navigator.geolocation) {
                    showStatus('Geolocation not supported', 3000);
                    return;
                }
                
                btn.textContent = '‚èπÔ∏è Stop Tracking';
                btn.classList.add('active');
                isTrackingLocation = true;
                
                // Send location immediately
                sendLocationUpdate();
                
                // Send location every 30 seconds
                trackingInterval = setInterval(sendLocationUpdate, 30000);
                
                showStatus('Location tracking started', 2000);
            }
        }

        // Send location update to server
        function sendLocationUpdate() {
            navigator.geolocation.getCurrentPosition(
                async function(position) {
                    try {
                        const locationData = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                            timestamp: new Date().toISOString(),
                            device_info: navigator.userAgent
                        };

                        const response = await fetch(`${API_BASE}/api/location-update`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(locationData)
                        });

                        if (response.ok) {
                            console.log('Location updated successfully');
                            // Refresh heatmap if it's visible
                            if (isHeatmapVisible) {
                                loadHeatmap();
                            }
                        }
                    } catch (error) {
                        console.error('Error sending location update:', error);
                    }
                },
                function(error) {
                    console.error('Error getting location for tracking:', error);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 5000,
                    maximumAge: 60000
                }
            );
        }

        // Update marker count display
        function updateMarkerCount() {
            const count = mapData.markers ? mapData.markers.length : 0;
            document.getElementById('markerCount').textContent = `${count} facilities found`;
        }

        // Show status message
        function showStatus(message, duration = null) {
            const statusBar = document.getElementById('statusBar');
            statusBar.textContent = message;
            statusBar.style.display = 'block';
            
            if (duration) {
                setTimeout(() => {
                    statusBar.style.display = 'none';
                }, duration);
            }
        }

        // Event listeners
        document.getElementById('locateBtn').addEventListener('click', getUserLocation);
        document.getElementById('refreshBtn').addEventListener('click', loadMapData);
        document.getElementById('clearRouteBtn').addEventListener('click', clearRoute);
        document.getElementById('toggleHeatmapBtn').addEventListener('click', toggleHeatmap);
        document.getElementById('trackLocationBtn').addEventListener('click', toggleLocationTracking);

        // Initialize map when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
        });
    </script>
</body>
</html>
